# This workflow will run tests using node and then publish a package to GitHub Packages when a release is created
# For more information see: https://help.github.com/actions/language-and-framework-guides/publishing-nodejs-packages

name: 'Angular API client Publish'

on:
  release:
    types: [prereleased, released]

jobs:
  test-publish-npm-packages:
    defaults:
      run:
        working-directory: './api-client/'
    runs-on: ubuntu-latest
    env:
      EVENT_CONTEXT: ${{ toJson(github.event) }}
    strategy:
      matrix:
        packages: ['sdk', 'schematics', 'plugin-builders']
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: 12
          registry-url: https://registry.npmjs.org/
      - run: echo "$EVENT_CONTEXT"
      - run: npm ci
      - run: npm run build:${{ matrix.packages }} --if-present
      - run: npm publish dist/vcd/${{ matrix.packages }} --dry-run
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
